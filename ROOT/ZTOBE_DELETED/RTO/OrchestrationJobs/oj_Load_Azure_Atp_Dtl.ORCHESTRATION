{"job":{"components":{"17884":{"id":17884,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":0,"y":32,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL_LOAD_STG"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"INSERT INTO  \"DATA_LAKE\".\"AZURE_ATP\".\"STG_ATP_ACTIVITIES\"\nSELECT parse_json($$${v_job_response}$$);"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[17900]},"17885":{"id":17885,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-144,"y":0,"width":32,"height":32,"inputConnectorIDs":[17895],"outputSuccessConnectorIDs":[17893],"outputFailureConnectorIDs":[17898],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"PYT"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print (myvar)\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print (context.getGridVariable('mygridvar'))\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\nimport requests\nimport json\nimport time\nimport sys\n# pyad.set_defaults(ldap_server=\"rpadauthf5.allegisgroup.com\", username=\"svc.matillion\", password=\"{?2k15IOG4v;8r#EZC+{6^dCUa=kHLVgDB$];At2\")\n# user = pyad.aduser.ADUser.from_cn(\"amagnuson\")\n# print(user.sid)\n\n# Provide the values for the variables below\ntoken_url = v_job_token_url\nsecret_key = v_job_secret_key\nsecret_id = v_job_secret_id\nscope = v_job_scope\n\n# Define the data to be sent in the POST request\ndata = {\n    \"grant_type\": \"client_credentials\",\n    \"client_id\": secret_id,\n    \"client_secret\": secret_key,\n    \"scope\": scope\n}\n\n# Send the POST request to fetch the OAuth token\nresponse = requests.post(token_url, data=data)\n# Check if the request was successful\nif response.status_code == 200:\n    # Extract the access token from the response\n    access_token = response.json()[\"access_token\"]\nelse:\n    print(\"Failed to fetch OAuth token\")\n\nurl = v_job_request_url\ntoo = 'Bearer '+access_token\ni=0\nfd=[]\nwhile i<=9:\n    st=time.time()\n    payload = {\"query\": \"IdentityLogonEvents | where AccountSid startswith @\\\"S-1-5-21-2076597496-1563261944-1256410061-\"+str(i)+\"\\\" and Application =~ \\\"Active Directory\\\" and ActionType =~ \\\"LogonSuccess\\\" and IPAddress startswith @\\\"10.\\\" and DeviceName !startswith @\\\"rp-exch\\\"| where Timestamp \\u003e ago(\"+str(int(v_loop_ite)+2)+\"h) and Timestamp \\u003c\\u003d ago(\"+str(v_loop_ite)+\"h) | order by Timestamp desc | project Timestamp, ActionType, Application, LogonType, Protocol, AccountName, AccountDomain, AccountUpn, AccountSid, AccountObjectId, AccountDisplayName, DeviceName, IPAddress, Port, DestinationDeviceName, DestinationIPAddress, DestinationPort, ISP, ReportId\"}\n    headers = {\n    'Content-Type': 'application/json',\n    'Authorization': too\n    }\n    # print(payload[\"query\"])\n    respons = requests.request(\"POST\", url, headers=headers, json=payload)\n    fna=[]\n    fd.append([respons.text])\n    '''l=0\n    print(sys.getsizeof(fn))\n    for a in fn[\"results\"]:\n        l+=1\n        fna.append([a[\"Timestamp\"],a[\"ActionType\"],a[\"Application\"],a[\"LogonType\"],a[\"Protocol\"],a[\"AccountName\"],a[\"AccountDomain\"],a[\"AccountUpn\"],a[\"AccountSid\"],a[\"AccountObjectId\"],a[\"AccountDisplayName\"],a[\"DeviceName\"],a[\"IPAddress\"],a[\"Port\"],a[\"DestinationDeviceName\"],a[\"DestinationIPAddress\"],a[\"DestinationPort\"],a[\"ISP\"],a[\"ReportId\"]])\n    kt=time.time()\n    print(kt-st,\"   \",l,\"   \",i)'''\n    i+=1\n    print(i)\ncontext.updateGridVariable('res_u', fd)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"17886":{"id":17886,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":128,"y":0,"width":32,"height":32,"inputConnectorIDs":[17892],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[17897],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"tj_Load_Azur_Atp_Dtl"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"tj_Load_Azur_Atp_Dtl"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"17887":{"id":17887,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"ITERATE","implementationID":-424773870,"x":0,"y":0,"width":32,"height":16,"inputConnectorIDs":[17893],"outputSuccessConnectorIDs":[17892],"outputFailureConnectorIDs":[17899],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Grid Iterator 0"}}}},"visible":true},"3":{"slot":3,"name":"Grid Variable","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"res_u"}}}},"visible":true},"4":{"slot":4,"name":"Grid Variable Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"data"},"2":{"slot":2,"type":"STRING","value":"v_job_response"}}}},"visible":true},"5":{"slot":5,"name":"Break on Failure","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false},"6":{"slot":6,"name":"Concurrency","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Concurrent"}}}},"visible":true},"7":{"slot":7,"name":"Stop on Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false},"8":{"slot":8,"name":"Stop Condition Mode","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Simple"}}}},"visible":false},"9":{"slot":9,"name":"Condition","elements":{},"visible":false},"10":{"slot":10,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":false},"11":{"slot":11,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"999":{"slot":999,"name":"Record Values In Task History","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[17900],"inputIterationConnectorIDs":[]},"17888":{"id":17888,"inputCardinality":"ZERO","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"NONE","implementationID":438858066,"x":0,"y":112,"width":32,"height":32,"inputConnectorIDs":[17896],"outputSuccessConnectorIDs":[17894],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SNS Message"}}}},"visible":true},"2":{"slot":2,"name":"AWS Region","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"us-east-1"}}}},"visible":true},"3":{"slot":3,"name":"Topic Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${v_job_sns}"}}}},"visible":true},"4":{"slot":4,"name":"Subject","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AWS Notification Message"}}}},"visible":true},"5":{"slot":5,"name":"Message","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Hi Team,\n\n${job_name} failed in project DCJ"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"17889":{"id":17889,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":-144,"y":112,"width":32,"height":32,"inputConnectorIDs":[17897,17898,17899],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[17896],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"17890":{"id":17890,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":128,"y":112,"width":32,"height":32,"inputConnectorIDs":[17894],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"17891":{"id":17891,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-288,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[17895],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"17892":{"id":17892,"sourceID":17887,"targetID":17886},"17893":{"id":17893,"sourceID":17885,"targetID":17887},"17894":{"id":17894,"sourceID":17888,"targetID":17890}},"failureConnectors":{"17897":{"id":17897,"sourceID":17886,"targetID":17889},"17898":{"id":17898,"sourceID":17885,"targetID":17889},"17899":{"id":17899,"sourceID":17887,"targetID":17889}},"unconditionalConnectors":{"17895":{"id":17895,"sourceID":17891,"targetID":17885},"17896":{"id":17896,"sourceID":17889,"targetID":17888}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{"17900":{"id":17900,"sourceID":17887,"targetID":17884}},"noteConnectors":{},"notes":{},"variables":{"v_job_request_url":{"definition":{"name":"v_job_request_url","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"https://graph.microsoft.com/v1.0/security/runHuntingQuery"},"v_job_response":{"definition":{"name":"v_job_response","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":""},"v_job_scope":{"definition":{"name":"v_job_scope","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"https://graph.microsoft.com/.default"},"v_job_secret_id":{"definition":{"name":"v_job_secret_id","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"aefb8b03-ceb3-4c78-8b56-fef6b1e9d6de"},"v_job_secret_key":{"definition":{"name":"v_job_secret_key","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"Zwx8Q~f1JKAEYkacDVZZlu~kPBx0oVezd4fZfba~"},"v_job_sns":{"definition":{"name":"v_job_sns","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"RTO-Data-PROD"},"v_job_token_url":{"definition":{"name":"v_job_token_url","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"https://login.microsoftonline.com/371cb917-b098-4303-b878-c182ec8403ac/oauth2/v2.0/token"},"v_loop_ite":{"definition":{"name":"v_loop_ite","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{"res_u":{"definition":{"name":"res_u","scope":"BRANCH","definitions":[{"name":"data","type":"TEXT"}],"description":"","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"oj_Load_Azure_Atp_Dtl","description":"","type":"ORCHESTRATION","tag":"385f8d83-f33f-4616-8d12-f3a7b5d9e9b7"}}